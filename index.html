<!DOCTYPE html>
<html lang="et">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Lausete Äraarvamise Mäng – Show MVP</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;700;900&display=swap');

        :root {
            --bg-color: #020617;
            --accent-color: #3b82f6;
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--bg-color);
            color: #f8fafc;
            overflow: hidden;
            transition: background-color 1s ease;
        }

        .finaal-bg {
            background: radial-gradient(circle at center, #1e1b4b 0%, #020617 100%);
        }

        .letter-box {
            width: 3.5rem;
            height: 4.5rem;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2.5rem;
            font-weight: 900;
            border-bottom: 4px solid #334155;
            margin: 0.25rem;
            transition: all 0.5s cubic-bezier(0.4, 0, 0.2, 1);
            transform-style: preserve-3d;
        }

        .letter-box.filled {
            border: 2px solid #3b82f6;
            background: #1e293b;
            border-radius: 0.5rem;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.3);
        }

        .letter-box.revealed {
            background: #3b82f6;
            border-color: #60a5fa;
            color: white;
            transform: rotateY(360deg);
        }

        .letter-box.final-auto {
            background: #4f46e5;
            border-color: #818cf8;
            box-shadow: 0 0 15px rgba(79, 70, 229, 0.6);
        }

        #phraseContainer {
            perspective: 1000px;
        }

        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-12px); }
            75% { transform: translateX(12px); }
        }
        .animate-shake { animation: shake 0.15s ease-in-out 0s 3; }

        @keyframes pulse-gold {
            0%, 100% { box-shadow: 0 0 0 0 rgba(245, 158, 11, 0.6); transform: scale(1); }
            50% { box-shadow: 0 0 40px 15px rgba(245, 158, 11, 0.3); transform: scale(1.05); }
        }
        .winner-glow { animation: pulse-gold 1.5s infinite; border-color: #f59e0b !important; }

        @keyframes next-step-pulse {
            0% { box-shadow: 0 0 0 0 rgba(255, 255, 255, 0.4); transform: scale(1); }
            50% { box-shadow: 0 0 30px 10px rgba(255, 255, 255, 0.2); transform: scale(1.03); }
            100% { box-shadow: 0 0 0 0 rgba(255, 255, 255, 0); transform: scale(1); }
        }

        .next-step-highlight {
            animation: next-step-pulse 1.5s infinite ease-in-out !important;
            border: 3px solid white !important;
            z-index: 10;
        }

        #toastContainer {
            position: fixed;
            top: 30px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 400;
            pointer-events: none;
            display: flex;
            flex-direction: column;
            gap: 10px;
            align-items: center;
        }

        .toast-msg {
            background: rgba(15, 23, 42, 0.85);
            backdrop-filter: blur(4px);
            border: 2px solid rgba(255,255,255,0.1);
            color: white;
            padding: 1.2rem 3rem;
            border-radius: 2rem;
            font-size: 1.8rem;
            font-weight: 900;
            text-transform: uppercase;
            letter-spacing: 0.1em;
            box-shadow: 0 20px 40px -10px rgba(0, 0, 0, 0.7);
            opacity: 0;
            transform: translateY(-30px);
            transition: all 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }
        .toast-msg.show {
            opacity: 1;
            transform: translateY(0);
        }

        @keyframes board-win-zoom {
            0% { transform: scale(0); opacity: 0; }
            60% { transform: scale(1.2); opacity: 1; }
            100% { transform: scale(1); opacity: 1; }
        }
        @keyframes pulse-soft {
            0%, 100% { transform: scale(1); filter: brightness(1); }
            50% { transform: scale(1.05); filter: brightness(1.2); }
        }

        #boardMessage {
            min-height: 120px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-top: 2rem;
            pointer-events: none;
        }

        .board-message-text {
            font-size: 5rem;
            font-weight: 900;
            text-transform: uppercase;
            text-align: center;
            opacity: 0;
            display: none;
            text-shadow: 0 0 30px currentColor, 0 10px 0 rgba(0,0,0,0.5);
            letter-spacing: -0.02em;
        }

        .board-message-text.show {
            display: block;
            opacity: 1;
            animation: board-win-zoom 0.6s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards, pulse-soft 2s ease-in-out infinite 0.6s;
        }

        .active-team {
            transform: scale(1.08);
            box-shadow: 0 0 40px rgba(59, 130, 246, 0.5);
            border-color: white !important;
        }

        .confetti {
            position: absolute;
            width: 10px;
            height: 10px;
            z-index: 600;
            border-radius: 2px;
        }

        #guessModal, #wheelModal {
            display: none;
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.85);
            backdrop-filter: blur(15px);
            z-index: 500;
            align-items: center;
            justify-content: center;
        }
        #guessModal.show, #wheelModal.show { display: flex; }

        .timer-warning {
            animation: timer-pulse 0.5s infinite alternate;
            color: #ef4444 !important;
            background-color: #450a0a !important;
            box-shadow: 0 0 20px #ef4444;
        }

        @keyframes timer-pulse {
            from { transform: scale(1); }
            to { transform: scale(1.2); }
        }

        #wheelWrapper {
            position: relative;
            width: 600px;
            height: 600px;
            margin: 0 auto;
            transform: scale(0.6);
            opacity: 0;
            transition: all 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }
        #wheelModal.show #wheelWrapper { transform: scale(1); opacity: 1; }

        #theWheel {
            width: 100%;
            height: 100%;
            border-radius: 50%;
            border: 15px solid #1e293b;
            box-shadow: 0 0 80px rgba(0,0,0,1), inset 0 0 40px rgba(0,0,0,0.5);
            transition: transform 4s cubic-bezier(0.15, 0, 0.15, 1);
            background: #0f172a;
        }

        #wheelPointer {
            position: absolute;
            top: -40px;
            left: 50%;
            transform: translateX(-50%);
            width: 80px;
            height: 100px;
            background: #ef4444;
            clip-path: polygon(50% 100%, 0 0, 100% 0);
            z-index: 30;
            filter: drop-shadow(0 10px 10px rgba(0,0,0,0.8));
        }

        .wheel-center-gold {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 80px;
            height: 80px;
            background: radial-gradient(circle, #fcd34d, #b45309);
            border: 8px solid #1e293b;
            border-radius: 50%;
            z-index: 25;
            box-shadow: 0 0 30px rgba(251, 191, 36, 0.6);
        }
    </style>
</head>
<body class="h-screen flex flex-col p-6 overflow-hidden">

    <!-- Toast Container -->
    <div id="toastContainer">
        <div id="toastMsg" class="toast-msg">TIIMI VAHETUS</div>
    </div>

    <!-- RATTA MODAAL -->
    <div id="wheelModal">
        <div class="flex flex-col items-center">
            <div id="wheelWrapper">
                <div id="wheelPointer"></div>
                <div class="wheel-center-gold"></div>
                <svg id="theWheel" viewBox="0 0 200 200">
                </svg>
            </div>
            <div id="spinResultText" class="mt-16 text-8xl font-black text-white uppercase tracking-tighter opacity-0 transform translate-y-10 transition-all duration-700">
                Tulemus...
            </div>
        </div>
    </div>

    <!-- Publiku Pakkumise Aken -->
    <div id="guessModal">
        <div class="bg-slate-900 p-10 rounded-[3rem] border-4 border-cyan-500 shadow-[0_0_100px_rgba(6,182,212,0.4)] w-full max-w-4xl text-center">
            <div id="guessStep1">
                <h2 class="text-6xl font-black text-cyan-400 mb-6 uppercase tracking-widest animate-pulse">SAAL PAKUB!</h2>
                <p class="text-3xl text-slate-300 mb-12 italic">Mängujuht, oota saali pakkumist...</p>
                <button id="modalRevealBtn" onclick="revealAnswerInModal()" class="bg-indigo-600 hover:bg-indigo-500 text-white font-black py-8 px-20 rounded-3xl text-4xl uppercase transition-all shadow-xl next-step-highlight">Näita Vastust</button>
            </div>
            <div id="guessStep2" class="hidden">
                <h2 class="text-3xl font-bold text-slate-400 mb-4 uppercase tracking-widest">Õige vastus on:</h2>
                <div id="fullPhraseDisplay" class="text-6xl font-black text-white mb-12 tracking-tight leading-tight">...</div>
                <h2 class="text-4xl font-bold text-slate-400 mb-10 uppercase">Kas oli õige?</h2>
                <div class="flex gap-10 justify-center">
                    <button onclick="confirmAudienceGuess(true)" class="bg-emerald-500 hover:bg-emerald-400 text-emerald-950 font-black py-6 px-20 rounded-3xl text-4xl uppercase transition-all shadow-[0_12px_0_#065f46]">JAH</button>
                    <button onclick="confirmAudienceGuess(false)" class="bg-rose-600 hover:bg-rose-500 text-white font-black py-6 px-20 rounded-3xl text-4xl uppercase transition-all shadow-[0_12px_0_#9f1239]">EI</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Päis -->
    <div class="flex justify-between items-start mb-6 gap-6">
        <div id="teamAContainer" class="bg-blue-600 p-5 rounded-3xl border-4 border-blue-400 text-center min-w-[220px] shadow-2xl transition-all duration-300 active-team">
            <h2 class="text-xl font-bold uppercase tracking-widest opacity-80 mb-1">Tiim A</h2>
            <div id="scoreA" class="text-7xl font-black">0</div>
            <div class="mt-4 flex justify-center gap-2">
                <button onclick="changeScore('A', -100)" class="bg-blue-800 hover:bg-blue-900 px-3 py-1 rounded-lg text-xs">-100</button>
                <button onclick="changeScore('A', 100)" class="bg-blue-300 hover:bg-blue-200 text-blue-900 px-3 py-1 rounded-lg font-bold text-xs">+100</button>
            </div>
        </div>

        <div class="text-center flex-1 px-4">
            <div id="categoryDisplay" class="text-5xl font-black text-blue-400 uppercase tracking-[0.4em] mb-2 drop-shadow-[0_4px_4px_rgba(0,0,0,0.5)]">KATEGOORIA</div>
            <div id="turnInfo" class="text-2xl text-emerald-400 font-bold uppercase tracking-widest mb-6">Tiim A kord</div>
            <div class="flex justify-center gap-12 items-center">
                <div id="roundDisplay" class="bg-slate-800 border-2 border-slate-700 text-slate-100 px-8 py-4 rounded-3xl font-black tracking-widest text-2xl shadow-2xl">I VOOR</div>
                <div id="timerDisplay" class="bg-amber-500 text-amber-950 px-8 py-4 rounded-3xl font-black text-5xl shadow-2xl min-w-[160px] transition-all">⏱ 0</div>
            </div>
        </div>

        <div id="teamBContainer" class="bg-rose-600 p-5 rounded-3xl border-4 border-rose-400 text-center min-w-[220px] shadow-2xl transition-all duration-300 opacity-50">
            <h2 class="text-xl font-bold uppercase tracking-widest opacity-80 mb-1">Tiim B</h2>
            <div id="scoreB" class="text-7xl font-black">0</div>
            <div class="mt-4 flex justify-center gap-2">
                <button onclick="changeScore('B', -100)" class="bg-rose-800 hover:bg-rose-900 px-3 py-1 rounded-lg text-xs">-100</button>
                <button onclick="changeScore('B', 100)" class="bg-rose-300 hover:bg-rose-200 text-rose-900 px-3 py-1 rounded-lg font-bold text-xs">+100</button>
            </div>
        </div>
    </div>

    <!-- Mänguväli -->
    <div id="gameBoard" class="flex-grow flex flex-col items-center justify-center py-6">
        <div id="phraseContainer" class="flex flex-wrap justify-center items-center max-w-7xl gap-y-12"></div>
        
        <div id="boardMessage">
            <div id="boardMsgText" class="board-message-text">LAUSE LAHENDATUD!</div>
        </div>
    </div>

    <!-- Juhised -->
    <div class="mb-4 text-center">
        <div id="instructionInfo" class="text-3xl text-cyan-400 font-black uppercase tracking-[0.2em] mb-4 hidden animate-pulse">Vali: 3 Kaashäälikut ja 1 Täishäälik</div>
        <div id="usedLetters" class="text-6xl font-black tracking-[0.5em] min-h-[4rem] flex justify-center items-center flex-wrap gap-4 text-slate-500"></div>
    </div>

    <!-- Alumine paneel -->
    <div id="bottomPanel" class="mt-auto flex flex-col xl:flex-row justify-between gap-6 items-center bg-slate-900/95 p-8 rounded-[3rem] border border-slate-700 shadow-[0_-20px_50px_rgba(0,0,0,0.8)]">
        <div class="flex flex-wrap justify-center gap-6">
            <button id="spinBtn" onclick="spinWheel()" class="bg-indigo-500 hover:bg-indigo-400 text-white font-black py-8 px-16 rounded-[2rem] text-4xl shadow-[0_12px_0_#4338ca] active:translate-y-2 active:shadow-none transition-all uppercase tracking-wider next-step-highlight">
                Keeruta Ratast
            </button>
            <button id="buyVowelBtn" onclick="buyVowel()" class="bg-amber-500 hover:bg-amber-400 text-amber-950 font-black py-8 px-12 rounded-[2rem] text-3xl shadow-[0_12px_0_#b45309] active:translate-y-2 active:shadow-none transition-all uppercase tracking-wider opacity-50">
                Osta Täishäälik
            </button>
            <button id="guessPhraseBtn" onclick="openGuessModal()" class="bg-cyan-500 hover:bg-cyan-400 text-cyan-950 font-black py-8 px-12 rounded-[2rem] text-3xl shadow-[0_12px_0_#0e7490] active:translate-y-2 active:shadow-none transition-all uppercase tracking-wider opacity-80">
                Arva Lause
            </button>
        </div>
        <div class="flex gap-4 items-center">
             <div class="flex bg-black/50 p-3 rounded-2xl gap-3">
                 <button onclick="startRound(1)" class="bg-slate-700 hover:bg-slate-600 px-6 py-4 rounded-xl font-black text-lg uppercase">I</button>
                 <button onclick="startRound(2)" class="bg-slate-700 hover:bg-slate-600 px-6 py-4 rounded-xl font-black text-lg uppercase">II</button>
                 <button onclick="startFinalRound()" class="bg-fuchsia-700 hover:bg-fuchsia-600 px-8 py-4 rounded-xl font-black text-lg uppercase shadow-lg shadow-fuchsia-900/40">Finaal</button>
             </div>
             <button id="newGameBtn" onclick="newGame()" class="bg-slate-800 hover:bg-slate-700 px-8 py-5 rounded-2xl font-black text-lg uppercase border-2 border-slate-600">Uus Mäng</button>
        </div>
    </div>

    <script>
        const AudioEngine = (() => {
            const ctx = new (window.AudioContext || window.webkitAudioContext)();
            const playTone = (freq, type, duration, vol = 0.1, ramp = true) => {
                const osc = ctx.createOscillator();
                const g = ctx.createGain();
                osc.type = type;
                osc.frequency.setValueAtTime(freq, ctx.currentTime);
                g.gain.setValueAtTime(vol, ctx.currentTime);
                if (ramp) g.gain.exponentialRampToValueAtTime(0.0001, ctx.currentTime + duration);
                osc.connect(g); g.connect(ctx.destination);
                osc.start(); osc.stop(ctx.currentTime + duration);
            };
            return {
                correct: () => { playTone(523.25, 'sine', 0.1, 0.1); setTimeout(() => playTone(659.25, 'sine', 0.2, 0.1), 100); },
                wrong: () => { playTone(220, 'sawtooth', 0.3, 0.05); playTone(210, 'sawtooth', 0.3, 0.05); },
                tick: () => playTone(800, 'triangle', 0.06, 0.04),
                bankrupt: () => { [300, 200, 150, 100].forEach((f, i) => setTimeout(() => playTone(f, 'sawtooth', 0.6, 0.05), i * 150)); },
                fanfare: () => { 
                    const notes = [523, 659, 783, 1046, 783, 1046, 1318];
                    notes.forEach((f, i) => setTimeout(() => playTone(f, 'square', 1.0, 0.07), i * 180)); 
                },
                timerTick: (isWarning) => playTone(isWarning ? 880 : 440, 'sine', 0.1, 0.03),
                resume: () => { if (ctx.state === 'suspended') ctx.resume(); }
            };
        })();

        const wheelSectors = [
            { type: "points", value: 100, label: "100", color: "#3b82f6" },
            { type: "points", value: 500, label: "500", color: "#10b981" },
            { type: "bankrupt", label: "PANKROT", color: "#000000" },
            { type: "points", value: 600, label: "600", color: "#8b5cf6" },
            { type: "points", value: 200, label: "200", color: "#f59e0b" },
            { type: "loseTurn", label: "JÄÄD VAHELE", color: "#ef4444" },
            { type: "points", value: 1000, label: "1000", color: "#ec4899" },
            { type: "double", label: "TOPELT", color: "#facc15" },
            { type: "points", value: 300, label: "300", color: "#06b6d4" },
            { type: "points", value: 1500, label: "1500", color: "#10b981" },
            { type: "points", value: 400, label: "400", color: "#6366f1" },
            { type: "points", value: 800, label: "800", color: "#f43f5e" }
        ];

        let currentPhrase = "", guessedLetters = new Set(), autoRevealedFinal = new Set();
        let scoreA = 0, scoreB = 0, activeTeam = "A", roundNumber = 1, roundLocked = false;
        let pendingAction = "none", currentWheelValue = null, timerSeconds = 0, timerInterval = null;
        let finalMode = false, finalConsonantsLeft = 0, finalVowelsLeft = 0, currentWheelRotation = 0;

        function updateHighlights() {
            document.querySelectorAll('.next-step-highlight').forEach(el => el.classList.remove('next-step-highlight'));
            const instr = document.getElementById('instructionInfo');
            instr.classList.add('hidden');
            
            if (roundLocked) {
                document.getElementById('newGameBtn').classList.add('next-step-highlight');
                return;
            }

            if (pendingAction === "none" && !finalMode) {
                document.getElementById('spinBtn').classList.add('next-step-highlight');
            } else if (pendingAction === "consonant") {
                instr.textContent = "VALI KAASHÄÄLIK";
                instr.classList.remove('hidden');
            } else if (pendingAction === "vowel") {
                instr.textContent = "VALI TÄISHÄÄLIK";
                instr.classList.remove('hidden');
            } else if (pendingAction === "finalPick") {
                updateFinalPickDisplay();
            } else if (finalMode && pendingAction === "none") {
                document.getElementById('guessPhraseBtn').classList.add('next-step-highlight');
                instr.textContent = "AEG ARVATA!";
                instr.classList.remove('hidden');
            }

            const currentScore = activeTeam === "A" ? scoreA : scoreB;
            const buyBtn = document.getElementById('buyVowelBtn');
            if (currentScore >= 250 && pendingAction === "none" && !finalMode) {
                buyBtn.classList.remove('opacity-50');
            } else {
                buyBtn.classList.add('opacity-50');
            }
        }

        function showToast(message, type = "info", duration = 2500) {
            const toast = document.getElementById("toastMsg");
            toast.textContent = message;
            toast.className = "toast-msg show";
            if (type === "success") toast.style.color = "#10b981";
            else if (type === "danger") toast.style.color = "#ef4444";
            else toast.style.color = "white";
            setTimeout(() => toast.classList.remove("show"), duration);
        }

        function showBoardOverlay(message, type = "success") { 
            const msgEl = document.getElementById("boardMsgText"); 
            msgEl.textContent = message; 
            msgEl.className = "board-message-text show " + (type === "success" ? "text-emerald-400" : "text-rose-500"); 
            updateHighlights();
        }

        function generateWheel() {
            const svg = document.getElementById("theWheel");
            svg.innerHTML = "";
            const step = 360 / wheelSectors.length;
            wheelSectors.forEach((s, i) => {
                const start = i * step, end = (i + 1) * step;
                const x1 = 100 + 100 * Math.cos(Math.PI * start / 180), y1 = 100 + 100 * Math.sin(Math.PI * start / 180);
                const x2 = 100 + 100 * Math.cos(Math.PI * end / 180), y2 = 100 + 100 * Math.sin(Math.PI * end / 180);
                const path = document.createElementNS("http://www.w3.org/2000/svg", "path");
                path.setAttribute("d", `M 100 100 L ${x1} ${y1} A 100 100 0 0 1 ${x2} ${y2} Z`);
                path.setAttribute("fill", s.color);
                path.setAttribute("stroke", "#ffffff");
                path.setAttribute("stroke-width", "0.5");
                svg.appendChild(path);
                const angle = start + step / 2;
                const tx = 100 + 75 * Math.cos(Math.PI * angle / 180), ty = 100 + 75 * Math.sin(Math.PI * angle / 180);
                const text = document.createElementNS("http://www.w3.org/2000/svg", "text");
                text.setAttribute("x", tx); text.setAttribute("y", ty); text.setAttribute("fill", "white");
                text.setAttribute("font-size", s.label.length > 8 ? "4" : "6"); text.setAttribute("font-weight", "900");
                text.setAttribute("text-anchor", "middle"); text.setAttribute("transform", `rotate(${angle + 90}, ${tx}, ${ty})`);
                text.textContent = s.label;
                svg.appendChild(text);
            });
        }

        function spinWheel() {
            if (roundLocked || finalMode || pendingAction !== "none") return;
            AudioEngine.resume();
            const modal = document.getElementById("wheelModal");
            const resultText = document.getElementById("spinResultText");
            const wheel = document.getElementById("theWheel");
            modal.classList.add("show");
            resultText.style.opacity = "0";
            const idx = Math.floor(Math.random() * wheelSectors.length);
            const sector = wheelSectors[idx];
            const step = 360 / wheelSectors.length;
            const target = 360 - (idx * step) - (step / 2) - 90;
            currentWheelRotation += (8 * 360) + (target - (currentWheelRotation % 360));
            requestAnimationFrame(() => { setTimeout(() => { wheel.style.transform = `rotate(${currentWheelRotation}deg)`; }, 50); });
            let ticks = 0; const tInt = setInterval(() => { AudioEngine.tick(); if (++ticks >= 28) clearInterval(tInt); }, 140);
            setTimeout(() => {
                resultText.innerText = sector.label; resultText.style.opacity = "1";
                setTimeout(() => { modal.classList.remove("show"); handleSpinResult(sector); }, 1600);
            }, 4200);
        }

        function handleSpinResult(sector) {
            if (sector.type === "bankrupt") {
                AudioEngine.bankrupt(); if (activeTeam === "A") scoreA = 0; else scoreB = 0; updateScoreDisplays();
                showToast("PANKROT!", "danger"); setTimeout(switchTeam, 1500);
            } else if (sector.type === "loseTurn") {
                AudioEngine.wrong(); showToast("JÄÄD VAHELE", "danger"); setTimeout(switchTeam, 1500);
            } else {
                pendingAction = "consonant"; currentWheelValue = sector.type === "double" ? 500 : (sector.value || 0);
                showToast(`PANUS: ${sector.label}. VALI KAASHÄÄLIK`); startTimer(15);
            }
            updateHighlights();
        }

        function switchTeam() {
            if (finalMode) return;
            pendingAction = "none"; currentWheelValue = null;
            activeTeam = activeTeam === "A" ? "B" : "A";
            document.getElementById("teamAContainer").classList.toggle("opacity-50", activeTeam !== "A");
            document.getElementById("teamBContainer").classList.toggle("opacity-50", activeTeam !== "B");
            document.getElementById("teamAContainer").classList.toggle("active-team", activeTeam === "A");
            document.getElementById("teamBContainer").classList.toggle("active-team", activeTeam === "B");
            const turnText = `Tiim ${activeTeam} kord`;
            document.getElementById("turnInfo").innerText = turnText;
            showToast(turnText, "info");
            updateHighlights();
        }

        function updateScoreDisplays() { document.getElementById("scoreA").innerText = scoreA; document.getElementById("scoreB").innerText = scoreB; updateHighlights(); }
        function changeScore(team, amount) { if (team === "A") scoreA = Math.max(0, scoreA + amount); else scoreB = Math.max(0, scoreB + amount); updateScoreDisplays(); }
        function buyVowel() { if (roundLocked || pendingAction !== "none" || finalMode) return; const s = activeTeam === "A" ? scoreA : scoreB; if (s < 250) { showToast("Vaja on 250 punkti", "danger"); return; } changeScore(activeTeam, -250); pendingAction = "vowel"; showToast("TÄISHÄÄLIK: 250p. Vali täht"); startTimer(15); updateHighlights(); }
        
        function openGuessModal() { if (roundLocked) return; stopTimer(); document.getElementById("guessStep1").classList.remove("hidden"); document.getElementById("guessStep2").classList.add("hidden"); document.getElementById("guessModal").classList.add("show"); }
        function revealAnswerInModal() { document.getElementById("guessStep1").classList.add("hidden"); document.getElementById("guessStep2").classList.remove("hidden"); document.getElementById("fullPhraseDisplay").innerText = currentPhrase; }
        
        function confirmAudienceGuess(isCorrect) {
            document.getElementById("guessModal").classList.remove("show");
            if (isCorrect) { [...currentPhrase].forEach(char => { if(/^[A-ZÕÄÖÜ]$/.test(char)) guessedLetters.add(char); }); renderPhrase(); handleWin(); }
            else { 
                AudioEngine.wrong(); 
                stopTimer();
                revealAll();
                showBoardOverlay("VALE PAKKUMINE! MÄNG LÄBI!", "danger");
            }
        }

        function handleGuess(letter) {
            if (roundLocked || pendingAction === "none") return;
            AudioEngine.resume(); if (guessedLetters.has(letter)) return;
            const isV = "AEIOUÕÄÖÜ".includes(letter);
            if (pendingAction === "finalPick") {
                if (isV && finalVowelsLeft > 0) { guessedLetters.add(letter); finalVowelsLeft--; AudioEngine.correct(); }
                else if (!isV && finalConsonantsLeft > 0) { guessedLetters.add(letter); finalConsonantsLeft--; AudioEngine.correct(); }
                else return;
                renderPhrase(); updateHighlights();
                if (finalConsonantsLeft === 0 && finalVowelsLeft === 0) { pendingAction = "none"; showToast("AEG ARVATA! (30s)", "success", 3000); startTimer(30); updateHighlights(); }
                return;
            }
            if ((isV && pendingAction !== "vowel") || (!isV && pendingAction !== "consonant")) return;
            guessedLetters.add(letter); stopTimer();
            let hits = 0; [...currentPhrase].forEach(ch => { if (ch === letter) hits++; });
            const u = document.getElementById("usedLetters"), span = document.createElement("span");
            span.innerText = letter;
            if (hits > 0) {
                AudioEngine.correct(); span.className = "text-blue-400 px-2 animate-bounce";
                if (!isV) { const t = currentWheelValue * hits * (roundNumber === 2 ? 2 : 1); changeScore(activeTeam, t); showToast(`ÕIGE! ${hits}x (+${t})`, "success"); }
                else showToast("ÕIGE!", "success");
                renderPhrase(); pendingAction = "none"; if (isPhraseSolved()) handleWin();
            } else { AudioEngine.wrong(); span.className = "text-slate-600 px-2"; showToast("VALE", "danger"); switchTeam(); }
            u.appendChild(span);
            updateHighlights();
        }

        function updateFinalPickDisplay() { 
            const instr = document.getElementById("instructionInfo"); 
            instr.innerText = `VALI VEEL: ${finalConsonantsLeft} KAASHÄÄLIKUT JA ${finalVowelsLeft} TÄISHÄÄLIK`; 
            instr.classList.remove("hidden");
        }
        
        function handleWin() { roundLocked = true; stopTimer(); AudioEngine.fanfare(); const b = finalMode ? 5000 : 1000; changeScore(activeTeam, b); createConfetti(finalMode ? 250 : 120); showBoardOverlay(finalMode ? "FINAALI VÕITJA!" : "LAUSE LAHENDATUD!", "success"); document.querySelectorAll('.letter-box.revealed').forEach((box, i) => { setTimeout(() => box.classList.add('winner-glow'), i * 40); }); updateHighlights(); }
        function startRound(n) { roundNumber = n; finalMode = (n === 3); newGame(); if (finalMode) startFinalSetup(); }
        function startFinalRound() { startRound(3); }
        function startFinalSetup() { document.body.classList.add("finaal-bg"); const unique = [...new Set([...currentPhrase].filter(c => /^[A-ZÕÄÖÜ]$/.test(c)))]; const auto = unique.sort(() => 0.5 - Math.random()).slice(0, 3); autoRevealedFinal = new Set(auto); auto.forEach((l, i) => { setTimeout(() => { guessedLetters.add(l); AudioEngine.tick(); renderPhrase(); }, i * 500); }); finalConsonantsLeft = 3; finalVowelsLeft = 1; setTimeout(() => { pendingAction = "finalPick"; updateHighlights(); showToast("FINAAL: VALI TÄHED", "success", 3000); updateHighlights(); }, auto.length * 500 + 500); }
        function startTimer(sec) { stopTimer(); timerSeconds = sec; const el = document.getElementById("timerDisplay"); updateTimerDisplay(); timerInterval = setInterval(() => { if (--timerSeconds <= 0) { stopTimer(); AudioEngine.wrong(); showToast("AEG SAI OTSA!", "danger"); revealAll(); if (!finalMode) switchTeam(); else showBoardOverlay("MÄNG LÄBI!", "danger"); } else { if (timerSeconds <= 10) el.classList.add("timer-warning"); AudioEngine.timerTick(timerSeconds <= 10); updateTimerDisplay(); } }, 1000); }
        function stopTimer() { clearInterval(timerInterval); timerInterval = null; document.getElementById("timerDisplay").classList.remove("timer-warning"); }
        function updateTimerDisplay() { document.getElementById("timerDisplay").innerText = `⏱ ${timerSeconds}`; }
        function isPhraseSolved() { for(const ch of currentPhrase) if(/^[A-ZÕÄÖÜ]$/.test(ch) && !guessedLetters.has(ch)) return false; return true; }
        function revealAll() { [...currentPhrase].forEach(char => { if (/^[A-ZÕÄÖÜ]$/.test(char)) guessedLetters.add(char); }); renderPhrase(); roundLocked = true; updateHighlights(); }
        function renderPhrase() { const c = document.getElementById("phraseContainer"); c.innerHTML = ""; currentPhrase.split(" ").forEach(word => { const d = document.createElement("div"); d.className = "flex mx-4 mb-2"; [...word].forEach(char => { const box = document.createElement("div"); if (/^[A-ZÕÄÖÜ]$/.test(char)) { const isR = guessedLetters.has(char); box.className = `letter-box filled ${isR ? 'revealed' : ''} ${isR && autoRevealedFinal.has(char) && finalMode ? 'final-auto' : ''}`; box.innerText = isR ? char : ""; } else { box.className = "letter-box revealed border-none bg-transparent"; box.innerText = char; } d.appendChild(box); }); c.appendChild(d); }); }
        
        const gameData = [
            { phrase: "Aeg parandab haavad aga jätab armid", category: "Vanasõna" },
            { phrase: "Ametil on kuldpõhi all", category: "Vanasõna" },
            { phrase: "Käbi ei kuku kännust kaugele", category: "Vanasõna" },
            { phrase: "Hulk kokki teeb lahja leeme", category: "Vanasõna" },
            { phrase: "Parem varblane peos kui tuvi katusel", category: "Vanasõna" },
            { phrase: "Siin me oleme", category: "Eesti Film" },
            { phrase: "Viimne reliikvia", category: "Eesti Film" },
            { phrase: "Tallinn on Eesti pealinn", category: "Fakt" }
        ];

        function newGame() { 
            const data = gameData[Math.floor(Math.random()*gameData.length)]; 
            currentPhrase = data.phrase.toUpperCase(); 
            guessedLetters.clear(); autoRevealedFinal.clear(); 
            roundLocked = false; pendingAction = "none"; stopTimer(); 
            if (!finalMode) document.body.classList.remove("finaal-bg"); 
            document.getElementById("roundDisplay").innerText = finalMode ? "FINAAL" : (roundNumber === 2 ? "II VOOR" : "I VOOR"); 
            document.getElementById("categoryDisplay").innerText = data.category; 
            document.getElementById("usedLetters").innerHTML = ""; 
            document.getElementById("timerDisplay").innerText = "⏱ 0"; 
            document.getElementById("instructionInfo").classList.add("hidden"); 
            document.getElementById("boardMsgText").classList.remove("show"); 
            renderPhrase(); 
            updateHighlights();
        }

        document.addEventListener("keydown", (e) => {
            const key = e.key.toUpperCase();
            if (key === "ENTER") { if (roundLocked) newGame(); else if (!finalMode && pendingAction === "none") spinWheel(); }
            else if (/^[A-ZÕÄÖÜ]$/.test(key)) handleGuess(key);
        });

        function createConfetti(count = 100) {
            for(let i=0; i<count; i++) {
                const conf = document.createElement('div');
                conf.className = 'confetti';
                conf.style.left = Math.random() * 100 + 'vw';
                conf.style.top = '-20px';
                conf.style.width = (Math.random() * 12 + 6) + 'px';
                conf.style.height = (Math.random() * 12 + 6) + 'px';
                conf.style.backgroundColor = ['#f59e0b','#10b981','#3b82f6','#ef4444','#f472b6','#facc15'][Math.floor(Math.random()*6)];
                document.body.appendChild(conf);
                const duration = 2.5 + Math.random() * 3.5;
                conf.animate([{ top: '-20px', opacity: 1, transform: 'rotate(0deg)' }, { top: '105vh', opacity: 0, transform: `rotate(${Math.random()*1440}deg) translateX(${Math.random()*150-75}px)` }], { duration: duration * 1000 });
                setTimeout(() => conf.remove(), duration * 1000);
            }
        }

        window.onload = () => { generateWheel(); newGame(); };
    </script>
</body>
</html>
