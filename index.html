<!DOCTYPE html>
<html lang="et">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Lausete Äraarvamise Mäng – Show MVP</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;700;900&display=swap');

        :root {
            --bg-color: #020617;
            --accent-color: #3b82f6;
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--bg-color);
            color: #f8fafc;
            overflow: hidden;
            transition: background-color 1s ease;
        }

        .finaal-bg {
            background: radial-gradient(circle at center, #1e1b4b 0%, #020617 100%);
        }

        .letter-box {
            width: 3.5rem;
            height: 4.5rem;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2.5rem;
            font-weight: 900;
            border-bottom: 4px solid #334155;
            margin: 0.25rem;
            transition: all 0.5s cubic-bezier(0.4, 0, 0.2, 1);
            transform-style: preserve-3d;
        }

        .letter-box.filled {
            border: 2px solid #3b82f6;
            background: #1e293b;
            border-radius: 0.5rem;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.3);
        }

        .letter-box.revealed {
            background: #3b82f6;
            border-color: #60a5fa;
            color: white;
            transform: rotateY(360deg);
        }

        .letter-box.final-auto {
            background: #4f46e5;
            border-color: #818cf8;
            box-shadow: 0 0 15px rgba(79, 70, 229, 0.6);
        }

        #phraseContainer {
            perspective: 1000px;
        }

        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-12px); }
            75% { transform: translateX(12px); }
        }
        .animate-shake { animation: shake 0.15s ease-in-out 0s 3; }

        @keyframes pulse-gold {
            0%, 100% { box-shadow: 0 0 0 0 rgba(245, 158, 11, 0.6); transform: scale(1); }
            50% { box-shadow: 0 0 40px 15px rgba(245, 158, 11, 0.3); transform: scale(1.05); }
        }
        .winner-glow { animation: pulse-gold 1.5s infinite; border-color: #f59e0b !important; }

        @keyframes gold-shimmer {
            0% { background-position: -200% center; }
            100% { background-position: 200% center; }
        }
        .text-gold {
            background: linear-gradient(90deg, #f59e0b, #fef3c7, #fbbf24, #f59e0b);
            background-size: 200% auto;
            -webkit-background-clip: text;
            background-clip: text;
            color: transparent;
            animation: gold-shimmer 3s linear infinite;
        }

        .overlay {
            position: fixed;
            inset: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            pointer-events: none;
            opacity: 0;
            transition: all 0.3s ease;
            z-index: 100;
            background: rgba(2, 6, 23, 0.85);
            backdrop-filter: blur(8px);
        }
        .overlay.show { opacity: 1; pointer-events: auto; }

        .overlay-badge {
            padding: 3rem;
            border-radius: 2.5rem;
            font-weight: 900;
            text-transform: uppercase;
            box-shadow: 0 0 60px rgba(0, 0, 0, 0.8);
            border: 5px solid rgba(255,255,255,0.1);
            text-align: center;
            max-width: 90%;
        }

        .active-team {
            transform: scale(1.08);
            box-shadow: 0 0 40px rgba(59, 130, 246, 0.5);
            border-color: white !important;
        }

        .confetti {
            position: absolute;
            width: 10px;
            height: 10px;
            z-index: 99;
            border-radius: 2px;
        }

        #guessModal {
            display: none;
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.9);
            backdrop-filter: blur(15px);
            z-index: 200;
            align-items: center;
            justify-content: center;
        }
        #guessModal.show { display: flex; }

        .timer-warning {
            animation: timer-pulse 0.5s infinite alternate;
            color: #ef4444 !important;
            background-color: #450a0a !important;
            box-shadow: 0 0 20px #ef4444;
        }

        @keyframes timer-pulse {
            from { transform: scale(1); }
            to { transform: scale(1.2); }
        }
    </style>
</head>
<body class="h-screen flex flex-col p-6 overflow-hidden">

    <!-- Publiku Pakkumise Aken -->
    <div id="guessModal">
        <div class="bg-slate-900 p-10 rounded-[3rem] border-4 border-cyan-500 shadow-[0_0_100px_rgba(6,182,212,0.4)] w-full max-w-4xl text-center">
            <!-- Esimene samm: Ootame pakkumist -->
            <div id="guessStep1">
                <h2 class="text-5xl font-black text-cyan-400 mb-6 uppercase tracking-widest animate-pulse">SAAL PAKUB!</h2>
                <p class="text-2xl text-slate-300 mb-12 italic">Mängujuht, oota saali pakkumist ja siis vajuta nuppu.</p>
                <button onclick="revealAnswerInModal()" class="bg-indigo-600 hover:bg-indigo-500 text-white font-black py-6 px-16 rounded-3xl text-3xl uppercase transition-all shadow-xl">Näita Vastust</button>
            </div>

            <!-- Teine samm: Vastuse kontroll -->
            <div id="guessStep2" class="hidden">
                <h2 class="text-3xl font-bold text-slate-400 mb-4 uppercase tracking-widest">Õige vastus on:</h2>
                <div id="fullPhraseDisplay" class="text-5xl font-black text-white mb-12 tracking-tight leading-tight">...</div>
                
                <h2 class="text-3xl font-bold text-slate-400 mb-8 uppercase">Kas pakkumine oli õige?</h2>
                <div class="flex gap-8 justify-center">
                    <button onclick="confirmAudienceGuess(true)" class="bg-emerald-500 hover:bg-emerald-400 text-emerald-950 font-black py-5 px-16 rounded-3xl text-3xl uppercase transition-all shadow-[0_10px_0_#065f46]">JAH</button>
                    <button onclick="confirmAudienceGuess(false)" class="bg-rose-600 hover:bg-rose-500 text-white font-black py-5 px-16 rounded-3xl text-3xl uppercase transition-all shadow-[0_10px_0_#9f1239]">EI</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Päis -->
    <div class="flex justify-between items-start mb-6 gap-6">
        <div id="teamAContainer" class="bg-blue-600 p-5 rounded-3xl border-4 border-blue-400 text-center min-w-[200px] shadow-2xl transition-all duration-300 active-team">
            <h2 class="text-xl font-bold uppercase tracking-widest opacity-80 mb-1">Tiim A</h2>
            <div id="scoreA" class="text-6xl font-black">0</div>
            <div class="mt-4 flex justify-center gap-2">
                <button onclick="changeScore('A', -100)" class="bg-blue-800 hover:bg-blue-900 px-3 py-1 rounded-lg text-xs">-100</button>
                <button onclick="changeScore('A', 100)" class="bg-blue-300 hover:bg-blue-200 text-blue-900 px-3 py-1 rounded-lg font-bold text-xs">+100</button>
            </div>
        </div>

        <div class="text-center flex-1 px-4">
            <div id="categoryDisplay" class="text-4xl font-black text-blue-400 uppercase tracking-[0.4em] mb-2 drop-shadow-[0_4px_4px_rgba(0,0,0,0.5)]">KATEGOORIA</div>
            <div id="turnInfo" class="text-2xl text-emerald-400 font-bold uppercase tracking-widest mb-6">Tiim A kord</div>

            <div class="flex justify-center gap-6">
                <div id="roundDisplay" class="bg-slate-800 border-2 border-slate-700 text-slate-100 px-8 py-4 rounded-3xl font-black tracking-widest text-xl shadow-2xl">I VOOR</div>
                <div id="wheelDisplay" class="bg-indigo-600 border-2 border-indigo-400 text-white px-10 py-4 rounded-3xl font-black text-3xl shadow-[0_0_30px_rgba(79,70,229,0.4)] min-w-[240px] flex items-center justify-center transition-all">
                    —
                </div>
                <div id="timerDisplay" class="bg-amber-500 text-amber-950 px-8 py-4 rounded-3xl font-black text-3xl shadow-2xl min-w-[120px] transition-all">⏱ 0</div>
            </div>
        </div>

        <div id="teamBContainer" class="bg-rose-600 p-5 rounded-3xl border-4 border-rose-400 text-center min-w-[200px] shadow-2xl transition-all duration-300 opacity-50">
            <h2 class="text-xl font-bold uppercase tracking-widest opacity-80 mb-1">Tiim B</h2>
            <div id="scoreB" class="text-6xl font-black">0</div>
            <div class="mt-4 flex justify-center gap-2">
                <button onclick="changeScore('B', -100)" class="bg-rose-800 hover:bg-rose-900 px-3 py-1 rounded-lg text-xs">-100</button>
                <button onclick="changeScore('B', 100)" class="bg-rose-300 hover:bg-rose-200 text-rose-900 px-3 py-1 rounded-lg font-bold text-xs">+100</button>
            </div>
        </div>
    </div>

    <!-- Mänguväli -->
    <div id="gameBoard" class="flex-grow flex items-center justify-center py-6">
        <div id="phraseContainer" class="flex flex-wrap justify-center items-center max-w-7xl gap-y-12"></div>
    </div>

    <!-- Pakutud tähed -->
    <div class="mb-8 text-center">
        <div id="instructionInfo" class="text-2xl text-cyan-400 font-black uppercase tracking-[0.2em] mb-4 hidden animate-pulse">Vali: 3 Kaashäälikut ja 1 Täishäälik</div>
        <div id="usedLetters" class="text-5xl font-black tracking-[0.5em] min-h-[4rem] flex justify-center items-center flex-wrap gap-4 text-slate-400"></div>
    </div>

    <!-- Alumine paneel -->
    <div id="bottomPanel" class="mt-auto flex flex-col xl:flex-row justify-between gap-6 items-center bg-slate-900/90 p-8 rounded-[2.5rem] border border-slate-700 shadow-[0_-20px_50px_rgba(0,0,0,0.5)]">
        <div class="flex flex-wrap justify-center gap-6">
            <button id="spinBtn" onclick="spinWheel()" class="bg-indigo-500 hover:bg-indigo-400 text-white font-black py-5 px-12 rounded-2xl text-2xl shadow-[0_10px_0_#4338ca] active:translate-y-1 active:shadow-none transition-all uppercase tracking-wider">
                Keeruta
            </button>

            <button id="buyVowelBtn" onclick="buyVowel()" class="bg-amber-500 hover:bg-amber-400 text-amber-950 font-black py-5 px-10 rounded-2xl text-2xl shadow-[0_10px_0_#b45309] active:translate-y-1 active:shadow-none transition-all uppercase tracking-wider">
                Osta Täishäälik
            </button>

            <button id="guessPhraseBtn" onclick="openGuessModal()" class="bg-cyan-500 hover:bg-cyan-400 text-cyan-950 font-black py-5 px-10 rounded-2xl text-2xl shadow-[0_10px_0_#0e7490] active:translate-y-1 active:shadow-none transition-all uppercase tracking-wider">
                Arva Lause
            </button>
        </div>

        <div class="flex gap-4 items-center">
             <div class="flex bg-black/40 p-2 rounded-2xl gap-2 mr-4">
                 <button onclick="startRound(1)" class="bg-slate-700 hover:bg-slate-600 px-5 py-3 rounded-xl font-black text-sm uppercase">I</button>
                 <button onclick="startRound(2)" class="bg-slate-700 hover:bg-slate-600 px-5 py-3 rounded-xl font-black text-sm uppercase">II</button>
                 <button onclick="startFinalRound()" class="bg-fuchsia-700 hover:bg-fuchsia-600 px-6 py-3 rounded-xl font-black text-sm uppercase shadow-lg shadow-fuchsia-900/40">Finaal</button>
             </div>
             <button onclick="newGame()" class="bg-slate-800 hover:bg-slate-700 px-6 py-4 rounded-2xl font-black text-sm uppercase border border-slate-600">Uus Mäng</button>
        </div>
    </div>

    <!-- Overlay -->
    <div id="overlayMessage" class="overlay">
        <div id="overlayText" class="overlay-badge">TEADE</div>
    </div>

    <script>
        const AudioEngine = (() => {
            const ctx = new (window.AudioContext || window.webkitAudioContext)();
            const playTone = (freq, type, duration, vol = 0.1, ramp = true) => {
                const osc = ctx.createOscillator();
                const g = ctx.createGain();
                osc.type = type;
                osc.frequency.setValueAtTime(freq, ctx.currentTime);
                g.gain.setValueAtTime(vol, ctx.currentTime);
                if (ramp) g.gain.exponentialRampToValueAtTime(0.0001, ctx.currentTime + duration);
                osc.connect(g); g.connect(ctx.destination);
                osc.start(); osc.stop(ctx.currentTime + duration);
            };
            return {
                correct: () => { playTone(523.25, 'sine', 0.1, 0.1); setTimeout(() => playTone(659.25, 'sine', 0.2, 0.1), 100); },
                wrong: () => { playTone(220, 'sawtooth', 0.3, 0.05); playTone(210, 'sawtooth', 0.3, 0.05); },
                tick: () => playTone(800, 'triangle', 0.05, 0.02),
                bankrupt: () => { [300, 200, 150, 100].forEach((f, i) => setTimeout(() => playTone(f, 'sawtooth', 0.6, 0.05), i * 150)); },
                fanfare: () => { 
                    const notes = [523, 659, 783, 1046, 783, 1046, 1318];
                    notes.forEach((f, i) => setTimeout(() => playTone(f, 'square', 1.0, 0.07), i * 180)); 
                },
                timerTick: (isWarning) => playTone(isWarning ? 880 : 440, 'sine', 0.1, 0.03),
                resume: () => { if (ctx.state === 'suspended') ctx.resume(); }
            };
        })();

        function createConfetti(count = 100) {
            for(let i=0; i<count; i++) {
                const conf = document.createElement('div');
                conf.className = 'confetti';
                conf.style.left = Math.random() * 100 + 'vw';
                conf.style.top = '-20px';
                conf.style.width = (Math.random() * 12 + 6) + 'px';
                conf.style.height = (Math.random() * 12 + 6) + 'px';
                conf.style.backgroundColor = ['#f59e0b','#10b981','#3b82f6','#ef4444','#f472b6','#facc15'][Math.floor(Math.random()*6)];
                document.body.appendChild(conf);
                const duration = 2.5 + Math.random() * 3.5;
                conf.animate([
                    { top: '-20px', opacity: 1, transform: 'rotate(0deg)' }, 
                    { top: '105vh', opacity: 0, transform: `rotate(${Math.random()*1440}deg) translateX(${Math.random()*150-75}px)` }
                ], { duration: duration * 1000, easing: 'cubic-bezier(0.1, 0, 0.3, 1)' });
                setTimeout(() => conf.remove(), duration * 1000);
            }
        }

        const gameData = [
            { phrase: "Aeg parandab haavad aga jätab armid", category: "Vanasõna" },
            { phrase: "Ametil on kuldpõhi all", category: "Vanasõna" },
            { phrase: "Käbi ei kuku kännust kaugele", category: "Vanasõna" },
            { phrase: "Hulk kokki teeb lahja leeme", category: "Vanasõna" },
            { phrase: "Parem varblane peos kui tuvi katusel", category: "Vanasõna" },
            { phrase: "Siin me oleme", category: "Eesti Film" },
            { phrase: "Viimne reliikvia", category: "Eesti Film" },
            { phrase: "Tallinn on Eesti pealinn", category: "Fakt" },
            { phrase: "Suvi on soe aeg", category: "Lause" }
        ];

        const LETTER_REGEX = /^[A-ZÕÄÖÜ]$/;
        const VOWELS = new Set(["A","E","I","O","U","Õ","Ä","Ö","Ü"]);
        const wheelSectors = [
            { type: "points", value: 200, label: "200" },
            { type: "points", value: 400, label: "400" },
            { type: "points", value: 600, label: "600" },
            { type: "loseTurn", label: "KAOTAD KORRA" },
            { type: "points", value: 900, label: "900" },
            { type: "bankrupt", label: "PANKROT" },
            { type: "points", value: 1500, label: "1500" },
            { type: "double", value: 500, label: "TOPELT x2" }
        ];

        let currentPhrase = "";
        let guessedLetters = new Set();
        let autoRevealedFinal = new Set();
        let scoreA = 0, scoreB = 0;
        let activeTeam = "A";
        let roundNumber = 1, roundLocked = false;
        let pendingAction = "none", currentWheelValue = null;
        let timerSeconds = 0, timerInterval = null;
        let finalMode = false;
        let finalConsonantsLeft = 0;
        let finalVowelsLeft = 0;
        let isTimerActiveBeforeModal = false;

        function updateScoreDisplays() {
            document.getElementById("scoreA").innerText = scoreA;
            document.getElementById("scoreB").innerText = scoreB;
        }

        function changeScore(team, amount) {
            if (team === "A") scoreA = Math.max(0, scoreA + amount);
            else scoreB = Math.max(0, scoreB + amount);
            updateScoreDisplays();
        }

        function showOverlay(message, type = "info", ms = 1500) {
            const wrap = document.getElementById("overlayMessage");
            const badge = document.getElementById("overlayText");
            badge.textContent = message;
            if (finalMode && type === "success") badge.className = "overlay-badge bg-black border-yellow-500 text-gold scale-125";
            else badge.className = "overlay-badge " + (type === "success" ? "bg-emerald-600 text-white border-emerald-400" : type === "danger" ? "bg-rose-600 text-white border-rose-400 animate-shake" : "bg-blue-600 text-white border-blue-400");
            wrap.classList.add("show");
            setTimeout(() => wrap.classList.remove("show"), ms);
        }

        function switchTeam() {
            if (finalMode) return;
            pendingAction = "none";
            currentWheelValue = null;
            document.getElementById("wheelDisplay").innerText = "—";
            activeTeam = activeTeam === "A" ? "B" : "A";
            document.getElementById("teamAContainer").classList.toggle("opacity-50", activeTeam !== "A");
            document.getElementById("teamBContainer").classList.toggle("opacity-50", activeTeam !== "B");
            document.getElementById("teamAContainer").classList.toggle("active-team", activeTeam === "A");
            document.getElementById("teamBContainer").classList.toggle("active-team", activeTeam === "B");
            document.getElementById("turnInfo").innerText = `Tiim ${activeTeam} kord`;
            showOverlay(`Tiim ${activeTeam} kord`);
        }

        function spinWheel() {
            if (roundLocked || finalMode) return;
            if (pendingAction !== "none") { showOverlay("Vali kõigepealt täht!", "danger"); return; }
            AudioEngine.resume();
            const display = document.getElementById("wheelDisplay");
            let spins = 0;
            const interval = setInterval(() => {
                const s = wheelSectors[Math.floor(Math.random() * wheelSectors.length)];
                display.innerText = s.label;
                AudioEngine.tick();
                if (++spins >= 16) { clearInterval(interval); handleSpinResult(s); }
            }, 70);
        }

        function handleSpinResult(sector) {
            if (sector.type === "bankrupt") {
                AudioEngine.bankrupt();
                if (activeTeam === "A") scoreA = 0; else scoreB = 0;
                updateScoreDisplays();
                document.getElementById("gameBoard").classList.add("animate-shake");
                setTimeout(() => document.getElementById("gameBoard").classList.remove("animate-shake"), 500);
                showOverlay("PANKROT!", "danger");
                setTimeout(switchTeam, 1500);
            } else if (sector.type === "loseTurn") {
                AudioEngine.wrong();
                showOverlay("KAOTAD KORRA", "danger");
                setTimeout(switchTeam, 1500);
            } else {
                pendingAction = "consonant";
                currentWheelValue = sector.value;
                showOverlay(`PANUS: ${sector.label}. Vali kaashäälik`);
                startTimer(15);
            }
        }

        function buyVowel() {
            if (roundLocked || pendingAction !== "none" || finalMode) return;
            const s = activeTeam === "A" ? scoreA : scoreB;
            if (s < 250) { showOverlay("Vaja on 250 punkti", "danger"); return; }
            changeScore(activeTeam, -250);
            pendingAction = "vowel";
            showOverlay("TÄISHÄÄLIK: 250p. Vali täht");
            startTimer(15);
        }

        function openGuessModal() {
            if (roundLocked) return;
            isTimerActiveBeforeModal = (timerInterval !== null);
            stopTimer(); 
            document.getElementById("guessStep1").classList.remove("hidden");
            document.getElementById("guessStep2").classList.add("hidden");
            document.getElementById("guessModal").classList.add("show");
        }

        function revealAnswerInModal() {
            document.getElementById("guessStep1").classList.add("hidden");
            document.getElementById("guessStep2").classList.remove("hidden");
            document.getElementById("fullPhraseDisplay").innerText = currentPhrase;
        }

        function confirmAudienceGuess(isCorrect) {
            document.getElementById("guessModal").classList.remove("show");
            if (isCorrect) {
                // Avame kõik tähed
                [...currentPhrase].forEach(char => {
                     if(LETTER_REGEX.test(char)) guessedLetters.add(char);
                });
                renderPhrase();
                handleWin();
            } else {
                AudioEngine.wrong();
                if (finalMode) {
                    stopTimer();
                    revealAll(); // Paljastame vastuse, kuna mäng on läbi
                    showOverlay("MÄNG LÄBI! VALE VASTUS", "danger", 5000);
                } else {
                    showOverlay("VALE VASTUS", "danger");
                    switchTeam();
                }
            }
        }

        function handleGuess(letter) {
            if (roundLocked || pendingAction === "none") return;
            AudioEngine.resume();
            if (guessedLetters.has(letter)) return;
            const isVowel = VOWELS.has(letter);

            if (pendingAction === "finalPick") {
                if (isVowel && finalVowelsLeft > 0) { guessedLetters.add(letter); finalVowelsLeft--; AudioEngine.correct(); }
                else if (!isVowel && finalConsonantsLeft > 0) { guessedLetters.add(letter); finalConsonantsLeft--; AudioEngine.correct(); }
                else return;
                renderPhrase();
                updateFinalPickDisplay();
                if (finalConsonantsLeft === 0 && finalVowelsLeft === 0) {
                    pendingAction = "none";
                    document.getElementById("instructionInfo").classList.add("hidden");
                    showOverlay("AEG ARVATA! (30s)", "success", 2500);
                    startTimer(30);
                }
                return;
            }

            if (isVowel && pendingAction !== "vowel") return;
            if (!isVowel && pendingAction !== "consonant") return;

            guessedLetters.add(letter);
            stopTimer();
            let hits = 0;
            for (const ch of currentPhrase) if (ch === letter) hits++;
            const usedEl = document.getElementById("usedLetters");
            const span = document.createElement("span");
            span.innerText = letter;

            if (hits > 0) {
                AudioEngine.correct();
                span.className = "text-blue-400 px-2 animate-bounce";
                if (!isVowel) {
                    const total = currentWheelValue * hits * (roundNumber === 2 ? 2 : 1);
                    changeScore(activeTeam, total);
                    showOverlay(`ÕIGE! ${hits}x (+${total})`, "success");
                } else showOverlay("ÕIGE!", "success");
                renderPhrase();
                pendingAction = "none";
                document.getElementById("wheelDisplay").innerText = "—";
                if (isPhraseSolved()) handleWin();
            } else {
                AudioEngine.wrong();
                span.className = "text-slate-600 px-2";
                showOverlay("VALE", "danger");
                switchTeam();
            }
            usedEl.appendChild(span);
        }

        function updateFinalPickDisplay() {
            const info = document.getElementById("instructionInfo");
            info.innerText = `Vali veel: ${finalConsonantsLeft} K ja ${finalVowelsLeft} T`;
            info.classList.remove("hidden");
        }

        function handleWin() {
            roundLocked = true;
            stopTimer();
            AudioEngine.fanfare();
            const bonus = finalMode ? 5000 : 1000;
            changeScore(activeTeam, bonus);
            createConfetti(finalMode ? 250 : 120);
            showOverlay(finalMode ? "FINAALI VÕITJA!" : "LAUSE LAHENDATUD!", "success", 5000);
            document.querySelectorAll('.letter-box.revealed').forEach((box, i) => {
                setTimeout(() => box.classList.add('winner-glow'), i * 40);
            });
        }

        function startRound(n) {
            roundNumber = n; finalMode = (n === 3); newGame();
            if (finalMode) startFinalSetup();
        }

        function startFinalRound() { startRound(3); }

        function startFinalSetup() {
            document.body.classList.add("finaal-bg");
            const roundEl = document.getElementById("roundDisplay");
            roundEl.className = "bg-amber-600 border-2 border-amber-400 text-white px-8 py-4 rounded-3xl font-black tracking-widest text-xl shadow-[0_0_30px_rgba(245,158,11,0.6)]";
            const uniqueLetters = [...new Set([...currentPhrase].filter(c => LETTER_REGEX.test(c)))];
            const shuffled = uniqueLetters.sort(() => 0.5 - Math.random());
            const autoLetters = shuffled.slice(0, 3);
            autoRevealedFinal = new Set(autoLetters);
            autoLetters.forEach((l, i) => {
                setTimeout(() => { guessedLetters.add(l); AudioEngine.tick(); renderPhrase(); }, i * 500);
            });
            finalConsonantsLeft = 3; finalVowelsLeft = 1;
            setTimeout(() => { pendingAction = "finalPick"; updateFinalPickDisplay(); showOverlay("FINAAL: Vali tähed klaviatuuril", "success", 2500); }, autoLetters.length * 500 + 500);
        }

        function startTimer(sec) {
            stopTimer(); timerSeconds = sec;
            const el = document.getElementById("timerDisplay");
            el.classList.remove("timer-warning");
            updateTimerDisplay();
            timerInterval = setInterval(() => {
                if (--timerSeconds <= 0) { 
                    stopTimer(); 
                    AudioEngine.wrong(); 
                    showOverlay("AEG LÄBI", "danger"); 
                    revealAll(); 
                    if (!finalMode) switchTeam(); 
                    else showOverlay("FINAAL LÄBI! AEG SAI OTSA", "danger", 5000);
                }
                else { if (timerSeconds <= 10) el.classList.add("timer-warning"); AudioEngine.timerTick(timerSeconds <= 10); updateTimerDisplay(); }
            }, 1000);
        }

        function stopTimer() { clearInterval(timerInterval); timerInterval = null; document.getElementById("timerDisplay").classList.remove("timer-warning"); }
        function updateTimerDisplay() { document.getElementById("timerDisplay").innerText = `⏱ ${timerSeconds}`; }
        function isPhraseSolved() { for(const ch of currentPhrase) if(LETTER_REGEX.test(ch) && !guessedLetters.has(ch)) return false; return true; }

        function revealAll() {
            [...currentPhrase].forEach(char => { if (LETTER_REGEX.test(char)) guessedLetters.add(char); });
            renderPhrase(); roundLocked = true;
        }

        function renderPhrase() {
            const container = document.getElementById("phraseContainer");
            container.innerHTML = "";
            currentPhrase.split(" ").forEach(word => {
                const wordDiv = document.createElement("div");
                wordDiv.className = "flex mx-4 mb-2";
                [...word].forEach(char => {
                    const box = document.createElement("div");
                    if (LETTER_REGEX.test(char)) {
                        const isRevealed = guessedLetters.has(char);
                        const isAuto = isRevealed && autoRevealedFinal.has(char) && finalMode;
                        box.className = `letter-box filled ${isRevealed ? 'revealed' : ''} ${isAuto ? 'final-auto' : ''}`;
                        box.innerText = isRevealed ? char : "";
                    } else { box.className = "letter-box revealed border-none bg-transparent"; box.innerText = char; }
                    wordDiv.appendChild(box);
                });
                container.appendChild(wordDiv);
            });
        }

        function newGame() {
            const data = gameData[Math.floor(Math.random()*gameData.length)];
            currentPhrase = data.phrase.toUpperCase();
            guessedLetters.clear(); autoRevealedFinal.clear();
            roundLocked = false; pendingAction = "none"; stopTimer();
            if (!finalMode) {
                document.body.classList.remove("finaal-bg");
                document.getElementById("roundDisplay").className = "bg-slate-800 border-2 border-slate-700 text-slate-100 px-8 py-4 rounded-3xl font-black tracking-widest text-xl shadow-2xl";
            }
            document.getElementById("roundDisplay").innerText = finalMode ? "FINAAL" : (roundNumber === 2 ? "II VOOR" : "I VOOR");
            document.getElementById("categoryDisplay").innerText = data.category;
            document.getElementById("usedLetters").innerHTML = "";
            document.getElementById("wheelDisplay").innerText = "—";
            document.getElementById("timerDisplay").innerText = "⏱ 0";
            document.getElementById("instructionInfo").classList.add("hidden");
            renderPhrase();
        }

        document.addEventListener("keydown", (e) => {
            const key = e.key.toUpperCase();
            if (key === "ENTER") { if (roundLocked) newGame(); else if (!finalMode && pendingAction === "none") spinWheel(); }
            else if (LETTER_REGEX.test(key)) handleGuess(key);
        });

        window.onload = newGame;
    </script>
</body>
</html>
